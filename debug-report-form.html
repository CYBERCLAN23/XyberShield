<!DOCTYPE html>
<html lang="fr">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Debug Report Form - XyberShield</title>
    <style>
        body {
            font-family: Arial, sans-serif;
            max-width: 800px;
            margin: 0 auto;
            padding: 20px;
            background: #0a192f;
            color: white;
        }
        .debug-section {
            background: rgba(16, 34, 64, 0.8);
            border: 1px solid rgba(0, 255, 102, 0.2);
            border-radius: 10px;
            padding: 20px;
            margin-bottom: 20px;
        }
        .test-btn {
            background: linear-gradient(135deg, #00ff66, #00cc44);
            color: #000;
            border: none;
            padding: 10px 20px;
            border-radius: 5px;
            cursor: pointer;
            margin: 5px;
            font-weight: bold;
        }
        .test-btn:hover {
            transform: translateY(-2px);
        }
        .result {
            background: rgba(0, 0, 0, 0.3);
            border-radius: 5px;
            padding: 10px;
            margin-top: 10px;
            white-space: pre-wrap;
            font-family: monospace;
        }
        .success { color: #00ff66; }
        .error { color: #ff4444; }
        .warning { color: #ffaa00; }
    </style>
</head>
<body>
    <h1>üîç Debug Report Form - XyberShield</h1>
    
    <div class="debug-section">
        <h3>üåê Connexion API</h3>
        <button class="test-btn" onclick="testApiConnection()">Test Connexion API</button>
        <button class="test-btn" onclick="testHealthEndpoint()">Test Health Endpoint</button>
        <div id="api-result" class="result"></div>
    </div>

    <div class="debug-section">
        <h3>üìù Test Soumission Formulaire</h3>
        <button class="test-btn" onclick="testFormSubmission()">Test Formulaire Simple</button>
        <button class="test-btn" onclick="testFormWithFiles()">Test avec Fichiers</button>
        <div id="form-result" class="result"></div>
    </div>

    <div class="debug-section">
        <h3>üîß Informations Syst√®me</h3>
        <button class="test-btn" onclick="showSystemInfo()">Afficher Info Syst√®me</button>
        <div id="system-result" class="result"></div>
    </div>

    <div class="debug-section">
        <h3>üìä Console Logs</h3>
        <div id="console-logs" class="result"></div>
    </div>

    <script>
        // Configuration API
        const API_BASE_URL = window.location.hostname === 'localhost' || window.location.hostname === '127.0.0.1'
            ? 'http://localhost:5000/api'
            : `${window.location.origin}/api`;

        console.log('üîç Debug Mode - API URL:', API_BASE_URL);

        // Capture console logs
        const originalLog = console.log;
        const originalError = console.error;
        const logs = [];

        console.log = function(...args) {
            logs.push({type: 'log', message: args.join(' '), time: new Date().toLocaleTimeString()});
            updateConsoleLogs();
            originalLog.apply(console, args);
        };

        console.error = function(...args) {
            logs.push({type: 'error', message: args.join(' '), time: new Date().toLocaleTimeString()});
            updateConsoleLogs();
            originalError.apply(console, args);
        };

        function updateConsoleLogs() {
            const container = document.getElementById('console-logs');
            container.innerHTML = logs.map(log => 
                `<div class="${log.type}">[${log.time}] ${log.message}</div>`
            ).join('');
        }

        function displayResult(containerId, message, type = 'success') {
            const container = document.getElementById(containerId);
            container.innerHTML = `<div class="${type}">${message}</div>`;
        }

        async function testApiConnection() {
            displayResult('api-result', 'Test en cours...', 'warning');
            
            try {
                const response = await fetch(API_BASE_URL.replace('/api', ''));
                const text = await response.text();
                
                if (response.ok) {
                    displayResult('api-result', `‚úÖ Serveur accessible\nStatus: ${response.status}\nResponse: ${text.substring(0, 200)}...`, 'success');
                } else {
                    displayResult('api-result', `‚ö†Ô∏è Serveur r√©pond mais erreur\nStatus: ${response.status}\nResponse: ${text}`, 'warning');
                }
            } catch (error) {
                displayResult('api-result', `‚ùå Erreur de connexion\nErreur: ${error.message}\nAPI URL: ${API_BASE_URL}`, 'error');
            }
        }

        async function testHealthEndpoint() {
            displayResult('api-result', 'Test health endpoint...', 'warning');
            
            try {
                const response = await fetch(`${API_BASE_URL}/health`);
                const data = await response.json();
                
                if (response.ok) {
                    displayResult('api-result', `‚úÖ Health endpoint OK\n${JSON.stringify(data, null, 2)}`, 'success');
                } else {
                    displayResult('api-result', `‚ö†Ô∏è Health endpoint erreur\nStatus: ${response.status}\n${JSON.stringify(data, null, 2)}`, 'warning');
                }
            } catch (error) {
                displayResult('api-result', `‚ùå Health endpoint inaccessible\nErreur: ${error.message}`, 'error');
            }
        }

        async function testFormSubmission() {
            displayResult('form-result', 'Test soumission formulaire...', 'warning');
            
            const testData = new FormData();
            testData.append('fullName', 'Test User');
            testData.append('email', 'test@example.com');
            testData.append('phone', '0123456789');
            testData.append('incidentType', 'phishing');
            testData.append('incidentDate', '2024-01-15T10:00');
            testData.append('description', 'Test de signalement pour debug');
            testData.append('impactLevel', 'medium');
            
            try {
                const response = await fetch(`${API_BASE_URL}/reports`, {
                    method: 'POST',
                    body: testData
                });
                
                const result = await response.json();
                
                if (response.ok) {
                    displayResult('form-result', `‚úÖ Formulaire envoy√© avec succ√®s!\n${JSON.stringify(result, null, 2)}`, 'success');
                } else {
                    displayResult('form-result', `‚ö†Ô∏è Erreur lors de l'envoi\nStatus: ${response.status}\n${JSON.stringify(result, null, 2)}`, 'warning');
                }
            } catch (error) {
                displayResult('form-result', `‚ùå Erreur r√©seau\nErreur: ${error.message}`, 'error');
            }
        }

        async function testFormWithFiles() {
            displayResult('form-result', 'Test avec fichier...', 'warning');
            
            // Cr√©er un fichier de test
            const testFile = new File(['Test file content'], 'test.txt', { type: 'text/plain' });
            
            const testData = new FormData();
            testData.append('fullName', 'Test User With File');
            testData.append('email', 'test@example.com');
            testData.append('incidentType', 'malware');
            testData.append('incidentDate', '2024-01-15T10:00');
            testData.append('description', 'Test avec fichier joint');
            testData.append('impactLevel', 'high');
            testData.append('files', testFile);
            
            try {
                const response = await fetch(`${API_BASE_URL}/reports`, {
                    method: 'POST',
                    body: testData
                });
                
                const result = await response.json();
                
                if (response.ok) {
                    displayResult('form-result', `‚úÖ Formulaire avec fichier envoy√©!\n${JSON.stringify(result, null, 2)}`, 'success');
                } else {
                    displayResult('form-result', `‚ö†Ô∏è Erreur avec fichier\nStatus: ${response.status}\n${JSON.stringify(result, null, 2)}`, 'warning');
                }
            } catch (error) {
                displayResult('form-result', `‚ùå Erreur avec fichier\nErreur: ${error.message}`, 'error');
            }
        }

        function showSystemInfo() {
            const info = {
                userAgent: navigator.userAgent,
                url: window.location.href,
                apiUrl: API_BASE_URL,
                localStorage: {
                    token: localStorage.getItem('token') ? 'Pr√©sent' : 'Absent',
                    user: localStorage.getItem('user') ? 'Pr√©sent' : 'Absent'
                },
                cookies: document.cookie || 'Aucun cookie',
                timestamp: new Date().toISOString()
            };
            
            displayResult('system-result', JSON.stringify(info, null, 2), 'success');
        }

        // Auto-test au chargement
        window.addEventListener('load', () => {
            console.log('üîç Debug page loaded');
            showSystemInfo();
        });
    </script>
</body>
</html>
